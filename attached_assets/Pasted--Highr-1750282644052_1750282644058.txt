
"""
Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ù„Ø©
ÙŠÙ…ÙƒÙ† Ù†Ø³Ø®Ù‡ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¹ Highrise Bot
"""

import json
import os
from datetime import datetime
from highrise import User
from highrise.models import *

class UserRecognitionSystem:
    def __init__(self, data_folder="user_data"):
        """
        ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        
        Args:
            data_folder (str): Ù…Ø¬Ù„Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        """
        self.data_folder = data_folder
        self.users_file = f"{data_folder}/users_data.json"
        self.moderators_file = f"{data_folder}/moderators_data.json"
        
        # Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        self.room_moderators = []  # Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´Ø±ÙÙŠ Ø§Ù„ØºØ±ÙØ©
        self.room_owner = None     # Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©
        self.room_king = None      # Ù…Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©
        self.room_queen = None     # Ù…Ù„ÙƒØ© Ø§Ù„ØºØ±ÙØ©
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        self.users_data = {}
        
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        self._initialize_system()

    def _initialize_system(self):
        """ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        os.makedirs(self.data_folder, exist_ok=True)
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self.users_data = self._load_users_data()
        self._load_moderators_data()
        
        print(f"âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        print(f"ğŸ“ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {self.data_folder}")
        print(f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: {len(self.users_data)}")
        print(f"ğŸ‘®â€â™‚ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {len(self.room_moderators)}")

    def _load_users_data(self):
        """ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ù„Ù"""
        try:
            if os.path.exists(self.users_file):
                with open(self.users_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            return {}
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {e}")
            return {}

    def _save_users_data(self):
        """Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù"""
        try:
            with open(self.users_file, 'w', encoding='utf-8') as f:
                json.dump(self.users_data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {e}")

    def _load_moderators_data(self):
        """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ù„Ù"""
        try:
            if os.path.exists(self.moderators_file):
                with open(self.moderators_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self.room_moderators = data.get("room_moderators", [])
                    self.room_owner = data.get("room_owner", None)
                    self.room_king = data.get("room_king", None)
                    self.room_queen = data.get("room_queen", None)
                    print(f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {len(self.room_moderators)} Ù…Ø´Ø±Ù")
            else:
                print("ğŸ“ Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø´Ø±Ù")
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {e}")
            self.room_moderators = []

    def _save_moderators_data(self):
        """Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù"""
        try:
            data = {
                "room_moderators": self.room_moderators,
                "room_owner": self.room_owner,
                "room_king": self.room_king,
                "room_queen": self.room_queen
            }
            with open(self.moderators_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {len(self.room_moderators)} Ù…Ø´Ø±Ù")
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {e}")

    def register_user(self, user: User):
        """
        ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
        
        Args:
            user (User): ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Highrise
            
        Returns:
            dict: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        """
        user_id = user.id
        current_time = datetime.now().isoformat()

        if user_id not in self.users_data:
            # Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            self.users_data[user_id] = {
                "username": user.username,
                "first_seen": current_time,
                "last_seen": current_time,
                "visit_count": 1,
                "user_type": "visitor",
                "is_active": True
            }
            print(f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: {user.username}")
        else:
            # Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            self.users_data[user_id]["username"] = user.username
            self.users_data[user_id]["last_seen"] = current_time
            self.users_data[user_id]["visit_count"] += 1
            self.users_data[user_id]["is_active"] = True

        self._save_users_data()
        return self.users_data[user_id]

    def get_user_info(self, user_id: str):
        """
        Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…
        
        Args:
            user_id (str): Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            
        Returns:
            dict or None: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ None
        """
        return self.users_data.get(user_id, None)

    def get_user_type(self, user: User):
        """
        ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±
        
        Args:
            user (User): ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            
        Returns:
            str: Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        """
        user_id = user.id

        # Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¨ÙˆØª - ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ
        if user.username == "VECTOR000":  # ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
            return "bot_developer"

        # Ø§Ù„Ù…Ù„Ùƒ ÙˆØ§Ù„Ù…Ù„ÙƒØ© - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©
        if self.room_king and user_id == self.room_king:
            return "room_king"

        if self.room_queen and user_id == self.room_queen:
            return "room_queen"

        # Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©
        if self.room_owner and user_id == self.room_owner:
            return "room_owner"

        # Ù…Ø´Ø±ÙÙŠ Ø§Ù„ØºØ±ÙØ©
        if user_id in self.room_moderators:
            return "moderator"

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰
        user_data = self.get_user_info(user_id)
        if user_data:
            stored_type = user_data.get("user_type", "visitor")
            if stored_type in ["moderator_designer", "designer", "room_owner", "room_king", "room_queen"]:
                return stored_type

        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡ Ø£ÙŠ ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙÙ‡Ùˆ Ø²Ø§Ø¦Ø±
        return "visitor"

    async def check_room_privileges(self, bot, user: User):
        """
        ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
        
        Args:
            bot: ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª
            user (User): Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡
            
        Returns:
            str: Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„ÙØ­Øµ
        """
        try:
            # ÙØ­Øµ Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø£ÙˆÙ„Ø§Ù‹
            if user.username == "VECTOR000":  # ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
                print(f"ğŸ”± ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…Ø·ÙˆØ± Ø§Ù„Ø¨ÙˆØª")
                return "bot_developer"

            # ÙØ­Øµ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø§Ù„ÙƒÙŠ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ø¹Ø±ÙˆÙÙŠÙ† - ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡Ø§
            known_room_owners = ["E__X", "selAbu_Nasser_711_"]  # ØºÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
            if user.username in known_room_owners:
                self.room_owner = user.id
                self.set_user_type(user.id, "room_owner")
                print(f"ğŸ‘‘ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ© (Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ø±ÙˆÙØ©)")
                return "room_owner"

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
            room_privileges = await bot.highrise.get_room_privilege(user.id)
            print(f"ğŸ” ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.username} Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©: {room_privileges}")

            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
            is_moderator = False
            is_designer = False
            is_owner = False

            if hasattr(room_privileges, 'moderator') and hasattr(room_privileges, 'designer'):
                # Ù†ÙˆØ¹ RoomPermissions
                is_moderator = room_privileges.moderator
                is_designer = room_privileges.designer
                print(f"ğŸ“Š ØªØ­Ù„ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.username}: Ù…Ø´Ø±Ù={is_moderator}, Ù…ØµÙ…Ù…={is_designer}")

            elif hasattr(room_privileges, 'privilege'):
                # Ù†ÙˆØ¹ Ù†Øµ
                privilege = room_privileges.privilege
                if privilege == "owner":
                    is_owner = True
                elif privilege == "moderator":
                    is_moderator = True
                print(f"ğŸ“Š ØµÙ„Ø§Ø­ÙŠØ© {user.username}: {privilege}")

            # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if is_owner:
                self.room_owner = user.id
                self.set_user_type(user.id, "room_owner")
                print(f"ğŸ‘‘ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ© (Ù…Ù† Highrise)")
                return "room_owner"

            elif is_moderator and is_designer:
                # Ù…Ø´Ø±Ù ÙˆÙ…ØµÙ…Ù…
                if user.id not in self.room_moderators:
                    self.room_moderators.append(user.id)
                    self._save_moderators_data()
                self.set_user_type(user.id, "moderator_designer")
                print(f"ğŸ‘®â€â™‚ï¸ğŸ¨ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…Ø´Ø±Ù ÙˆÙ…ØµÙ…Ù…")
                return "moderator_designer"

            elif is_moderator:
                # Ù…Ø´Ø±Ù ÙÙ‚Ø·
                if user.id not in self.room_moderators:
                    self.room_moderators.append(user.id)
                    self._save_moderators_data()
                self.set_user_type(user.id, "moderator")
                print(f"ğŸ‘®â€â™‚ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…Ø´Ø±Ù")
                return "moderator"

            elif is_designer:
                # Ù…ØµÙ…Ù… ÙÙ‚Ø·
                self.set_user_type(user.id, "designer")
                print(f"ğŸ¨ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒÙ…ØµÙ…Ù…")
                return "designer"

            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡ Ø£ÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§ØµØ©ØŒ ÙÙ‡Ùˆ Ø²Ø§Ø¦Ø±
            self.set_user_type(user.id, "visitor")
            print(f"ğŸ‘¤ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ {user.username} ÙƒØ²Ø§Ø¦Ø±")
            return "visitor"

        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.username}: {e}")

            # ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·
            if user.username == "VECTOR000":  # ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
                print(f"ğŸ”§ Ø­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: {user.username} Ù…Ø·ÙˆØ± Ø§Ù„Ø¨ÙˆØª")
                return "bot_developer"

            # ÙØ­Øµ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙˆÙÙŠÙ† ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            known_room_owners = ["E__X", "selAbu_Nasser_711_"]  # ØºÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ
            if user.username in known_room_owners:
                self.room_owner = user.id
                self.set_user_type(user.id, "room_owner")
                print(f"ğŸ”§ Ø­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: {user.username} Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©")
                return "room_owner"

            # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØµØ¨Ø­ÙˆØ§ Ø²ÙˆØ§Ø±
            self.set_user_type(user.id, "visitor")
            print(f"ğŸ”§ Ø­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: {user.username} Ø²Ø§Ø¦Ø±")
            return "visitor"

    def check_permissions(self, user: User, required_permission: str):
        """
        ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        
        Args:
            user (User): Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            required_permission (str): Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            
        Returns:
            bool: True Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        """
        user_type = self.get_user_type(user)

        print(f"ğŸ” ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.username}: Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… = {user_type}, Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© = {required_permission}")

        # Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ù‡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if user_type == "bot_developer":
            print(f"âœ… {user.username} ØµÙ„Ø§Ø­ÙŠØ§Øª {required_permission}: True (Ù…Ø·ÙˆØ±)")
            return True

        # ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
        if required_permission == "developer":
            result = user_type == "bot_developer"
            print(f"{'âœ…' if result else 'âŒ'} {user.username} ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±: {result}")
            return result

        # Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©
        if required_permission == "owner":
            result = user_type in ["bot_developer", "room_owner"]
            print(f"{'âœ…' if result else 'âŒ'} {user.username} ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ: {result}")
            return result

        # ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù
        if required_permission == "moderate":
            # ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            is_real_moderator = user.id in self.room_moderators
            
            result = (user_type in ["bot_developer", "room_owner", "moderator", "moderator_designer", "room_king", "room_queen"] 
                     or is_real_moderator)
            
            print(f"{'âœ…' if result else 'âŒ'} {user.username} ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù: {result}")
            print(f"  ğŸ“‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {is_real_moderator}")
            print(f"  ğŸ“Š Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_type}")
            
            return result

        return False

    def set_user_type(self, user_id: str, user_type: str):
        """
        ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        
        Args:
            user_id (str): Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            user_type (str): Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            
        Returns:
            bool: True Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­
        """
        if user_id in self.users_data:
            self.users_data[user_id]["user_type"] = user_type
            self._save_users_data()
            return True
        return False

    def set_room_king(self, user_id: str):
        """ØªØ¹ÙŠÙŠÙ† Ù…Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©"""
        self.room_king = user_id
        if user_id in self.users_data:
            self.users_data[user_id]["user_type"] = "room_king"
            self._save_users_data()
        self._save_moderators_data()
        return True

    def set_room_queen(self, user_id: str):
        """ØªØ¹ÙŠÙŠÙ† Ù…Ù„ÙƒØ© Ø§Ù„ØºØ±ÙØ©"""
        self.room_queen = user_id
        if user_id in self.users_data:
            self.users_data[user_id]["user_type"] = "room_queen"
            self._save_users_data()
        self._save_moderators_data()
        return True

    def remove_room_king(self):
        """Ø¥Ø²Ø§Ù„Ø© Ù…Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©"""
        if self.room_king and self.room_king in self.users_data:
            self.users_data[self.room_king]["user_type"] = "visitor"
            self._save_users_data()
        self.room_king = None
        self._save_moderators_data()
        return True

    def remove_room_queen(self):
        """Ø¥Ø²Ø§Ù„Ø© Ù…Ù„ÙƒØ© Ø§Ù„ØºØ±ÙØ©"""
        if self.room_queen and self.room_queen in self.users_data:
            self.users_data[self.room_queen]["user_type"] = "visitor"
            self._save_users_data()
        self.room_queen = None
        self._save_moderators_data()
        return True

    def get_permission_text(self, user: User):
        """
        Ù†Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        
        Args:
            user (User): Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            
        Returns:
            str: Ù†Øµ ÙŠÙˆØ¶Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        """
        user_type = self.get_user_type(user)

        permissions_text = {
            "visitor": "ğŸ‘¤ Ø²Ø§Ø¦Ø±",
            "designer": "ğŸ¨ Ù…ØµÙ…Ù… Ø§Ù„ØºØ±ÙØ©",
            "moderator": "ğŸ‘®â€â™‚ï¸ Ù…Ø´Ø±Ù Ø§Ù„ØºØ±ÙØ©", 
            "moderator_designer": "ğŸ‘®â€â™‚ï¸ğŸ¨ Ù…Ø´Ø±Ù ÙˆÙ…ØµÙ…Ù…",
            "room_owner": "ğŸ‘‘ Ù…Ø§Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©",
            "room_king": "ğŸ¤´ Ù…Ù„Ùƒ Ø§Ù„ØºØ±ÙØ©",
            "room_queen": "ğŸ‘¸ Ù…Ù„ÙƒØ© Ø§Ù„ØºØ±ÙØ©",
            "bot_developer": "ğŸ”± Ù…Ø·ÙˆØ± Ø§Ù„Ø¨ÙˆØª"
        }

        return permissions_text.get(user_type, "ğŸ‘¤ Ø²Ø§Ø¦Ø±")

    def mark_user_offline(self, user_id: str):
        """ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        if user_id in self.users_data:
            self.users_data[user_id]["is_active"] = False
            self.users_data[user_id]["last_seen"] = datetime.now().isoformat()
            self._save_users_data()

    def get_online_users(self):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†"""
        online_users = {}
        for user_id, data in self.users_data.items():
            if data.get("is_active", False):
                online_users[user_id] = data
        return online_users

    def get_user_stats(self):
        """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
        total_users = len(self.users_data)
        online_users = len(self.get_online_users())
        real_moderators = len(self.room_moderators) if self.room_moderators else 0

        return {
            "total_users": total_users,
            "online_users": online_users,
            "moderators": real_moderators,
            "room_owner": 1 if self.room_owner else 0,
            "room_king": 1 if self.room_king else 0,
            "room_queen": 1 if self.room_queen else 0
        }

    def add_moderator(self, user_id: str):
        """Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯"""
        if user_id not in self.room_moderators:
            self.room_moderators.append(user_id)
            self.set_user_type(user_id, "moderator")
            self._save_moderators_data()
            return True
        return False

    def remove_moderator(self, user_id: str):
        """Ø¥Ø²Ø§Ù„Ø© Ù…Ø´Ø±Ù"""
        if user_id in self.room_moderators:
            self.room_moderators.remove(user_id)
            self.set_user_type(user_id, "visitor")
            self._save_moderators_data()
            return True
        return False

    def get_all_moderators(self):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†"""
        moderators_info = []
        for mod_id in self.room_moderators:
            user_data = self.get_user_info(mod_id)
            if user_data:
                moderators_info.append({
                    "user_id": mod_id,
                    "username": user_data.get("username", "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),
                    "user_type": user_data.get("user_type", "moderator")
                })
        return moderators_info

# Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
"""
# ÙÙŠ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:

from user_recognition_system import UserRecognitionSystem

class MyBot(BaseBot):
    def __init__(self):
        super().__init__()
        # ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        self.user_system = UserRecognitionSystem("my_bot_data")
    
    async def on_user_join(self, user: User, position: Position):
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„Ù‡
        user_data = self.user_system.register_user(user)
        
        # ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
        user_type = await self.user_system.check_room_privileges(self, user)
        
        # ØªØ±Ø­ÙŠØ¨ Ù…Ø®ØµØµ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        permission_text = self.user_system.get_permission_text(user)
        await self.highrise.chat(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.username} - {permission_text}")
    
    async def on_chat(self, user: User, message: str):
        # ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø´Ø±Ø§Ù
        if message.startswith("ÙƒØªÙ…"):
            if self.user_system.check_permissions(user, "moderate"):
                # ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„ÙƒØªÙ…
                pass
            else:
                await self.highrise.send_whisper(user.id, "âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
"""
